(()=>{"use strict";let e;const t=(e,t)=>{const o=new XMLHttpRequest;o.open("get",e),o.setRequestHeader("Accept","application/json"),o.onload=()=>t(o),o.send()},o=e=>{switch(e.status){case 204:return ye("There are no rooms yet!");case 404:ye("For some reason server braindead... Or its creator is...");break;default:ye("I dont know what the fork happened here!")}const t=JSON.parse(e.response);fe(t.rooms)},r=()=>{t("/roomList",o)},a=e=>{const t=JSON.parse(e.response);switch(e.status){case 201:ge(t.room);break;case 400:case 404:ue(t.message);break;default:ue("I dont know what the fork happened here!")}},l=t=>{const o=JSON.parse(t.response);switch(t.status){case 200:e=o.room.id,ge(o.room);break;case 400:ye(o.message);break;case 404:ye("Something has gone wrong real bad");break;default:ue("I dont know what the fork happened here!")}},n=(e,t,o,r)=>({x:Math.floor(e/o.width*r.width),y:Math.floor(t/o.height*r.height)}),s=e=>`#${("00"+e.r.toString(16)).slice(-2)}${("00"+e.g.toString(16)).slice(-2)}${("00"+e.b.toString(16)).slice(-2)}`;let i;const c={r:0,g:0,b:0,a:255},h=e=>{const t=(o=e.target.value,(r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(o))?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16),a:255}:null);var o,r;m(t.r,t.g,t.b,t.a)},d=()=>c,m=(e,t,o,r)=>{c.r=e,c.g=t,c.b=o,c.a=r},u=(e,t,o,r=255)=>({r:e,g:t,b:o,a:r});let g,p,f,y,w={};const S=(e,t,o)=>{if(e<0||e>=w.width||t<0||t>=w.height)return;let r=b(e,t,w.width);P(r,o,u(y[r],y[r+1],y[r+2],y[r+3])),y[r]=o.r,y[r+1]=o.g,y[r+2]=o.b,y[r+3]=o.a,p.putImageData(f,0,0)},x=(e,t)=>{e<0||e>=y.length||(y[e]=t.r,y[e+1]=t.g,y[e+2]=t.b,y[e+3]=t.a,p.putImageData(f,0,0))},N=(e,t,o,r,a)=>{let l=Math.abs(o-e),n=Math.abs(r-t),s=e<o?1:-1,i=t<r?1:-1,c=l-n;for(;e!==o||t!==r;){S(e,t,a);let o=2*c;o>-n&&(c-=n,e+=s),o<=l&&(c+=l,t+=i)}},b=(e,t,o)=>t*(4*o)+4*e;let q,k,v,C,I=[],R=[],$=[],E=0;const P=(e,t,o)=>{v||$.find((t=>t.pixelIndex===e))||($.push({pixelIndex:e,toColor:{...t},fromColor:{...o}}),R=[],k=!0)},D=()=>{if(I.length<=0)return;let e=I.pop();if(null===e)return;v=!0,R.push(e);let t=e.changes;for(let e=0;e<t.length;e++){let o=t[e];x(o.pixelIndex,o.fromColor)}E--,v=!1,L()},H=()=>{if(R.length<=0)return;let e=R.pop();if(null===e)return;C=!0,I.push(e);let t=e.changes;for(let e=0;e<t.length;e++){let o=t[e];x(o.pixelIndex,o.toColor)}E++,C=!1,L()},L=()=>{for(;q.firstChild;)q.removeChild(q.firstChild);for(let e=0;e<I.length;e++){const t=document.createElement("p");t.innerText=`${I[e].changeNumber}. ${I[e].message}`,e===I.length-1&&(t.style.border="1px solid white"),q.append(t)}q.scrollTop=q.scrollHeight;for(let e=R.length-1;e>=0;e--){const t=document.createElement("p");t.innerText=`${R[e].changeNumber}. ${R[e].message}`,t.style.fontStyle="italic",t.style.color="#aaaaaa",q.append(t)}};let M,T,z,B,O,j={};const A=(e,t,o,r)=>{if(O="Erased Pixels...",null!=t){let a=n(e.x,e.y,o,r),l=n(t.x,t.y,o,r);N(a.x,a.y,l.x,l.y,u(0,0,0,0)),S(a.x,a.y,u(0,0,0,0))}},J=(e,t,o,r)=>{if(O=`Penciled Pixels as ${s(d())}...`,null!=t){let a=n(e.x,e.y,o,r),l=n(t.x,t.y,o,r);N(a.x,a.y,l.x,l.y,d()),S(a.x,a.y,d())}},X=(e,t,o,r)=>{let a=n(e.x,e.y,o,r);var l;l=((e,t)=>{if(e<0||e>=w.width||t<0||t>=w.height)return;let o=b(e,t,w.width);return u(y[o],y[o+1],y[o+2],y[o+3])})(a.x,a.y),m(l.r,l.g,l.b,l.a),i.value=s(c)},F=()=>{B=z.Eraser},Y=()=>{B=z.Pencil},G=()=>{B=z.Dropper};let K,Q,U,V={width:64,height:64},W={width:600,height:600},Z={x:-1,y:-1},_=!1;const ee=e=>{var t,o,r;V=e,K=document.querySelector("#rawimage"),t=V.width,o=V.height,r=K,w.width=t,w.height=o,g=r,g.width=t,g.height=o,p=g.getContext("2d"),(()=>{f=p.createImageData(w.width,w.height),y=f.data;for(let e=0;e<y.length;e+=4)y[e]=0,y[e+1]=0,y[e+2]=0,y[e+3]=0;p.putImageData(f,0,0)})(),Q=document.querySelector("#display"),((e,t,o)=>{window.devicePixelRatio,j.width=e,j.height=t,M=o,M.width=e,M.height=t,T=M.getContext("2d"),T.imageSmoothingEnabled=!1,T.mozImageSmoothingEnabled=!1,T.webkitImageSmoothingEnabled=!1,T.msImageSmoothingEnabled=!1})(W.width,W.height,Q),i=document.querySelector("#colorPicker"),i.onchange=h,(()=>{const e=document.querySelector("#historyHolder");q=e.querySelector("#changes");const t=e.querySelector("#undo"),o=e.querySelector("#redo");t.onclick=D,o.onclick=H})(),document.querySelector("#eraser").onclick=F,document.querySelector("#pencil").onclick=Y,document.querySelector("#dropper").onclick=G,z={Eraser:A,Pencil:J,Dropper:X},B=z.Pencil,Q.onmousedown=oe,document.onmouseup=re,document.onmousemove=ae,Q.touchstart=oe,document.touchend=re,document.touchmove=ae,te()},te=()=>{var e,t;requestAnimationFrame(te),e=g,T.clearRect(0,0,j.width,j.height),T.save(),T.fillStyle="white",T.fillRect(0,0,j.width,j.height),T.restore(),T.drawImage(e,0,0,e.width,e.height,0,0,j.width,j.height),_&&((e,t,o,r)=>{B(e,t,o,r)})(Z,U,W,V),!_&&k&&(t=O,k=!1,I.push({time:Date.now(),changes:$,changeNumber:E+=1,message:t}),$=[],I.length>1e3&&I.shift(),L()),U=Z},oe=e=>{_=!0},re=e=>{_=!1},ae=e=>{const t=Q.getBoundingClientRect();Z={x:e.clientX-t.x,y:e.clientY-t.y}};let le,ne,se,ie;const ce=()=>{le.className="left",ne.className="right",se.className="center",ie.className="right"},he=()=>{r();let e=le.querySelector("#roomList");for(;e.firstChild;)e.removeChild(e.firstChild)},de=()=>{le.className="center",se.className="right",se.className="right",ie.className="right"},me=()=>{le.className="left",ne.className="center",se.className="left",ie.className="right";((e,t)=>{((e,t,o,r)=>{const a=new XMLHttpRequest;a.open("post","/createRoom"),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.setRequestHeader("Accept","application/json"),a.onload=()=>t(a),a.send(r)})(0,a,0,`roomName=${e}&canvasSize=${t}`)})(se.querySelector("#roomName").value,se.querySelector("#canvasSize").value)},ue=e=>{le.className="left",ne.className="right",se.className="center",ie.className="right",se.querySelector("#message").innerText=e},ge=e=>{le.className="left",ne.className="left",se.className="left",ie.className="center",ee({width:parseInt(e.canvasSize),height:parseInt(e.canvasSize)})},pe=e=>{var o;o=e.target.name,le.className="left",ne.className="center",se.className="right",se.style.visibility="hidden",ie.className="right",(e=>{t("/joinRoom?id="+e,l)})(o)},fe=e=>{let t=le.querySelector("#roomList");for(;t.firstChild;)t.removeChild(t.firstChild);let o=Object.keys(e);if(void 0!==o)if(o.length<=0)console.dir("empty");else for(let r=0;r<o.length;r++)we(e[o[r]].id,e[o[r]].name,t);else console.dir("null")},ye=e=>{let t=le.querySelector("#roomList");for(;t.firstChild;)t.removeChild(t.firstChild);t.innerText=e},we=(e,t,o)=>{const r=document.createElement("input");r.type="button",r.id=e,r.name=e,r.value=t,r.onclick=pe,o.append(r)};window.onload=()=>{le=document.querySelector("#menu"),ne=document.querySelector("#loadingRoom"),se=document.querySelector("#createRoom"),ie=document.querySelector("#paint"),le.querySelector("#createNewRoomButton").onclick=ce,le.querySelector("#refreshRoomListButton").onclick=he,se.querySelector("#returnToMenuButton").onclick=de,se.querySelector("#createRoomButton").onclick=me,r()}})();