(()=>{"use strict";const e=(e,t,o,a)=>({x:Math.floor(e/o.width*a.width),y:Math.floor(t/o.height*a.height)}),t=e=>`#${("00"+e.r.toString(16)).slice(-2)}${("00"+e.g.toString(16)).slice(-2)}${("00"+e.b.toString(16)).slice(-2)}`;let o;const a={r:0,g:0,b:0,a:255},r=e=>{const t=(o=e.target.value,(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(o))?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16),a:255}:null);var o,a;n(t.r,t.g,t.b,t.a)},s=()=>a,n=(e,t,o,r)=>{a.r=e,a.g=t,a.b=o,a.a=r},l=(e,t,o,a=255)=>({r:e,g:t,b:o,a});let i,c,h,d,m=[],g=[],u=[],p=0;const f=()=>{if(m.length<=0)return;let e=m.pop();if(null===e)return;h=!0,g.push(e);let t=e.changes;for(let e=0;e<t.length;e++){let o=t[e];v(o.pixelIndex,o.fromColor)}C(),p--,h=!1,w()},y=()=>{if(g.length<=0)return;let e=g.pop();if(null===e)return;d=!0,m.push(e);let t=e.changes;for(let e=0;e<t.length;e++){let o=t[e];v(o.pixelIndex,o.toColor)}C(),p++,d=!1,w()},w=()=>{for(;i.firstChild;)i.removeChild(i.firstChild);for(let e=0;e<m.length;e++){const t=document.createElement("p");t.innerText=`${m[e].changeNumber}. ${m[e].message}`,e===m.length-1&&(t.style.border="1px solid white"),i.append(t)}i.scrollTop=i.scrollHeight;for(let e=g.length-1;e>=0;e--){const t=document.createElement("p");t.innerText=`${g[e].changeNumber}. ${g[e].message}`,t.style.fontStyle="italic",t.style.color="#aaaaaa",i.append(t)}};let b,S,x,k,N={};const I=(e,t,o)=>{if(e<0||e>=N.width||t<0||t>=N.height)return;let a=P(e,t,N.width);var r,s,n;r=a,s=o,n=l(k[a],k[a+1],k[a+2],k[a+3]),h||u.find((e=>e.pixelIndex===r))||(u.push({pixelIndex:r,toColor:{...s},fromColor:{...n}}),g=[],c=!0),k[a]=o.r,k[a+1]=o.g,k[a+2]=o.b,k[a+3]=o.a},v=(e,t)=>{e<0||e>=k.length||(k[e]=t.r,k[e+1]=t.g,k[e+2]=t.b,k[e+3]=t.a)},q=(e,t,o,a,r)=>{let s=Math.abs(o-e),n=Math.abs(a-t),l=e<o?1:-1,i=t<a?1:-1,c=s-n;for(;e!==o||t!==a;){I(e,t,r);let o=2*c;o>-n&&(c-=n,e+=l),o<=s&&(c+=s,t+=i)}},C=()=>{S.putImageData(x,0,0)},P=(e,t,o)=>t*(4*o)+4*e;let R,$,M="#FF00FF",E=0,F=[];const T=(e,t)=>{const o=new XMLHttpRequest;o.open("get",e),o.setRequestHeader("Accept","application/json"),o.onload=()=>t(o),o.send()},O=(e,t,o,a)=>{const r=new XMLHttpRequest;r.open("post",e),r.setRequestHeader("Content-type",o),r.setRequestHeader("Accept","application/json"),r.onload=()=>t(r),r.send(a)},j=()=>{T("/roomList",D)},D=e=>{switch(e.status){case 204:return $e("There are no rooms yet!");case 404:$e("For some reason server braindead... Or its creator is...");break;default:$e("I dont know what happened here!")}const t=JSON.parse(e.response);Re(t.rooms)},H=e=>{const o=JSON.parse(e.response);switch(e.status){case 201:R=o.room.id,M=t(l(255*Math.random(),255*Math.random(),255*Math.random(),255)),E=o.playerId,Ce(o.room);break;case 400:case 404:qe(o.message);break;default:qe("I dont know what happened here!")}},L=e=>{switch(e.status){case 204:break;case 400:case 404:console.error(obj.message);break;default:console.error("I dont know what happened here!")}},X=e=>{const t=JSON.parse(e.response);switch(e.status){case 200:F=[],F=t.players;break;case 400:console.error("The data sent to the server was incorrect!");break;case 404:console.error(t.message);break;default:console.error("I dont know what happened here!")}},J=e=>{const o=JSON.parse(e.response);switch(e.status){case 200:R=o.room.id,M=t(l(255*Math.random(),255*Math.random(),255*Math.random(),255)),E=o.playerId,o.room.changes.length>0&&($=o.room.changes[o.room.changes.length-1].timeStamp),Ce(o.room);break;case 400:$e(o.message);break;case 404:$e("Something has gone wrong real bad");break;default:qe("I dont know what happened here!")}},z=e=>{switch(e.status){case 204:break;case 400:$e(obj.message);break;case 404:$e("Something has gone wrong real bad");break;default:qe("I dont know what happened here!")}},B=e=>{const t=JSON.parse(e.response);switch(e.status){case 200:let e=t.changes;e.length>0&&($=e[e.length-1].timeStamp);for(let t=0;t<e.length;t++){let o=e[t].change;for(let e=0;e<o.length;e++)v(o[e].pixelIndex,o[e].toColor)}C();break;case 400:$e(t.message);break;case 404:$e("Something has gone wrong real bad");break;default:qe("I dont know what happened here!")}};let Y,A,G={},K=[];const Q=(e,t,o)=>{A.save(),A.fillStyle=o,A.beginPath(),A.arc(e,t,5,0,2*Math.PI),A.fill(),A.restore()};let U,V,W;const Z=(t,o,a,r)=>{if(W="Erased Pixels...",null!=o){let s=e(t.x,t.y,a,r),n=e(o.x,o.y,a,r);q(s.x,s.y,n.x,n.y,l(0,0,0,0)),I(s.x,s.y,l(0,0,0,0))}},_=(o,a,r,n)=>{if(W=`Penciled Pixels as ${t(s())}...`,null!=a){let t=e(o.x,o.y,r,n),l=e(a.x,a.y,r,n);q(t.x,t.y,l.x,l.y,s()),I(t.x,t.y,s())}},ee=(r,s,i,c)=>{let h=e(r.x,r.y,i,c);var d;d=((e,t)=>{if(e<0||e>=N.width||t<0||t>=N.height)return;let o=P(e,t,N.width);return l(k[o],k[o+1],k[o+2],k[o+3])})(h.x,h.y),n(d.r,d.g,d.b,d.a),o.value=t(a)},te=()=>{V=U.Eraser},oe=()=>{V=U.Pencil},ae=()=>{V=U.Dropper};let re,se,ne,le={width:64,height:64},ie={width:600,height:600},ce={x:-1,y:-1},he=!1,de=.1,me=.1;const ge=e=>{var t,a,s;le=e,re=document.querySelector("#rawimage"),t=le.width,a=le.height,s=re,N.width=t,N.height=a,b=s,b.width=t,b.height=a,S=b.getContext("2d"),(()=>{x=S.createImageData(N.width,N.height),k=x.data;for(let e=0;e<k.length;e+=4)k[e]=0,k[e+1]=0,k[e+2]=0,k[e+3]=0;S.putImageData(x,0,0)})(),se=document.querySelector("#display"),((e,t,o)=>{window.devicePixelRatio,G.width=e,G.height=t,Y=o,Y.width=e,Y.height=t,A=Y.getContext("2d"),A.imageSmoothingEnabled=!1,A.mozImageSmoothingEnabled=!1,A.webkitImageSmoothingEnabled=!1,A.msImageSmoothingEnabled=!1})(ie.width,ie.height,se),o=document.querySelector("#colorPicker"),o.onchange=r,(()=>{const e=document.querySelector("#historyHolder");i=e.querySelector("#changes");const t=e.querySelector("#undo"),o=e.querySelector("#redo");t.onclick=f,o.onclick=y})(),document.querySelector("#eraser").onclick=te,document.querySelector("#pencil").onclick=oe,document.querySelector("#dropper").onclick=ae,U={Eraser:Z,Pencil:_,Dropper:ee},V=U.Pencil,se.onmousedown=pe,document.onmouseup=fe,document.onmousemove=ye,se.touchstart=pe,document.touchend=fe,document.touchmove=ye,ue()},ue=()=>{var e;requestAnimationFrame(ue),e=b,A.clearRect(0,0,G.width,G.height),A.save(),A.fillStyle="white",A.fillRect(0,0,G.width,G.height),A.restore(),A.drawImage(e,0,0,e.width,e.height,0,0,G.width,G.height),he&&(((e,t,o,a)=>{V(e,t,o,a)})(ce,ne,ie,le),C()),!he&&c&&(e=>{c=!1;const t={time:Date.now(),changes:u,changeNumber:p+=1,message:e};m.push(t),u=[],m.length>1e3&&m.shift(),(e=>{e.roomId=R,O("/sendChange",z,"application/json",JSON.stringify(e))})({time:t.time,changes:t.changes}),w()})(W),de-=1/60,de<=0&&(de=.1,T(`/getPlayers?roomId=${R}`,X),ne.x==ce.x&&ne.y==ce.y||(e=>{O("/updatePlayer",L,"application/x-www-form-urlencoded",`roomId=${R}&playerId=${E}&mousePosX=${e.x}&mousePosY=${e.y}&color=${M}`)})(ce)),Q(ce.x,ce.y,M),((e,t)=>{K.length!=e.length&&(K=e);for(let o=0;o<e.length;o++)if(e[o].id!=t){let t=parseFloat(K[o].position.mousePosX),a=parseFloat(K[o].position.mousePosY),r=parseFloat(e[o].position.mousePosX),s=parseFloat(e[o].position.mousePosY);t<0&&(t=r),a<0&&(a=s);let n=1/60*5*(r-t),l=1/60*5*(s-a),i=e[o].color;K[o].position.mousePosX=t+n,K[o].position.mousePosY=a+l,Q(t+n,a+l,i)}})(F,E),me-=1/60,me<=0&&(me=.1,void 0===$&&($=Date.now()),T("/getChanges?roomId="+R+"&timeStamp="+$,B)),ne=ce},pe=e=>{he=!0},fe=e=>{he=!1},ye=e=>{const t=se.getBoundingClientRect();ce={x:e.clientX-t.x,y:e.clientY-t.y}};let we,be,Se,xe;const ke=()=>{j();let e=we.querySelector("#roomList");for(;e.firstChild;)e.removeChild(e.firstChild)},Ne=()=>{we.className="center",Se.className="right",Se.className="right",xe.className="right"},Ie=()=>{we.className="left",be.className="right",Se.className="center",xe.className="right",Se.style.visibility="visible"},ve=()=>{var e,t;we.className="left",be.className="center",Se.className="left",xe.className="right",e=Se.querySelector("#roomName").value,t=Se.querySelector("#canvasSize").value,O("/createRoom",H,"application/x-www-form-urlencoded",`roomName=${e}&canvasSize=${t}`)},qe=e=>{we.className="left",be.className="right",Se.className="center",xe.className="right",Se.querySelector("#message").innerText=e},Ce=e=>{we.className="left",be.className="left",Se.className="left",xe.className="center",ge({width:parseInt(e.canvasSize),height:parseInt(e.canvasSize)});const t=e.changes;for(let e=0;e<t.length;e++){let o=t[e].change;for(let e=0;e<o.length;e++)v(o[e].pixelIndex,o[e].toColor)}},Pe=e=>{var t;t=e.target.name,we.className="left",be.className="center",Se.className="right",Se.style.visibility="hidden",xe.className="right",(e=>{T("/joinRoom?id="+e,J)})(t)},Re=e=>{let t=we.querySelector("#roomList");for(;t.firstChild;)t.removeChild(t.firstChild);let o=Object.keys(e);if(void 0!==o)if(o.length<=0)console.dir("Room list is empty for some reason");else for(let a=0;a<o.length;a++)Me(e[o[a]].id,"Room Name: "+e[o[a]].name+" | Id: "+o[a],t);else console.dir("Room list is broken")},$e=e=>{let t=we.querySelector("#roomList");for(;t.firstChild;)t.removeChild(t.firstChild);t.innerText=e},Me=(e,t,o)=>{const a=document.createElement("input");a.type="button",a.id=e,a.name=e,a.className="button",a.value=t,a.onclick=Pe,o.append(a)};window.onload=()=>{we=document.querySelector("#menu"),be=document.querySelector("#loadingRoom"),Se=document.querySelector("#createRoom"),xe=document.querySelector("#paint"),we.querySelector("#createNewRoomButton").onclick=Ie,we.querySelector("#refreshRoomListButton").onclick=ke,Se.querySelector("#returnToMenuButton").onclick=Ne,Se.querySelector("#createRoomButton").onclick=ve,xe.querySelector("#backToMenu").onclick=Ne,j()}})();