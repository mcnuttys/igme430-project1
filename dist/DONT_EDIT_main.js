(()=>{"use strict";const e=(e,t,o,r)=>({x:Math.floor(e/o.width*r.width),y:Math.floor(t/o.height*r.height)}),t=e=>`#${("00"+e.r.toString(16)).slice(-2)}${("00"+e.g.toString(16)).slice(-2)}${("00"+e.b.toString(16)).slice(-2)}`;let o;const r={r:0,g:0,b:0,a:255},a=e=>{const t=(o=e.target.value,(r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(o))?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16),a:255}:null);var o,r;n(t.r,t.g,t.b,t.a)},s=()=>r,n=(e,t,o,a)=>{r.r=e,r.g=t,r.b=o,r.a=a},l=(e,t,o,r=255)=>({r:e,g:t,b:o,a:r});let c,i="#FF00FF",h=0,d=[];const m=(e,t)=>{const o=new XMLHttpRequest;o.open("get",e),o.setRequestHeader("Accept","application/json"),o.onload=()=>t(o),o.send()},u=(e,t,o,r)=>{const a=new XMLHttpRequest;a.open("post",e),a.setRequestHeader("Content-type",o),a.setRequestHeader("Accept","application/json"),a.onload=()=>t(a),a.send(r)},g=e=>{switch(e.status){case 204:return ve("There are no rooms yet!");case 404:ve("For some reason server braindead... Or its creator is...");break;default:ve("I dont know what the fork happened here!")}const t=JSON.parse(e.response);qe(t.rooms)},p=()=>{m("/roomList",g)},f=e=>{const o=JSON.parse(e.response);switch(e.status){case 201:c=o.room.id,i=t(l(255*Math.random(),255*Math.random(),255*Math.random(),255)),h=o.playerId,ke(o.room);break;case 400:case 404:xe(o.message);break;default:xe("I dont know what the fork happened here!")}},y=e=>{switch(e.status){case 204:break;case 400:console.error("The data sent to the server was incorrect!");break;case 404:console.error(obj.message);break;default:console.error("I dont know what the fork happened here!")}},w=e=>{const t=JSON.parse(e.response);switch(e.status){case 200:d=[],d=t.players;break;case 400:console.error("The data sent to the server was incorrect!");break;case 404:console.error(t.message);break;default:console.error("I dont know what the fork happened here!")}},S=e=>{const o=JSON.parse(e.response);switch(e.status){case 200:c=o.room.id,i=t(l(255*Math.random(),255*Math.random(),255*Math.random(),255)),h=o.playerId,ke(o.room);break;case 400:ve(o.message);break;case 404:ve("Something has gone wrong real bad");break;default:xe("I dont know what the fork happened here!")}};let b,x,k,N,q={};const v=(e,t,o)=>{if(e<0||e>=q.width||t<0||t>=q.height)return;let r=$(e,t,q.width);F(r,o,l(N[r],N[r+1],N[r+2],N[r+3])),N[r]=o.r,N[r+1]=o.g,N[r+2]=o.b,N[r+3]=o.a,x.putImageData(k,0,0)},I=(e,t)=>{e<0||e>=N.length||(N[e]=t.r,N[e+1]=t.g,N[e+2]=t.b,N[e+3]=t.a,x.putImageData(k,0,0))},C=(e,t,o,r,a)=>{let s=Math.abs(o-e),n=Math.abs(r-t),l=e<o?1:-1,c=t<r?1:-1,i=s-n;for(;e!==o||t!==r;){v(e,t,a);let o=2*i;o>-n&&(i-=n,e+=l),o<=s&&(i+=s,t+=c)}},$=(e,t,o)=>t*(4*o)+4*e;let P,R,M,E,T=[],D=[],H=[],L=0;const F=(e,t,o)=>{M||H.find((t=>t.pixelIndex===e))||(H.push({pixelIndex:e,toColor:{...t},fromColor:{...o}}),D=[],R=!0)},O=()=>{if(T.length<=0)return;let e=T.pop();if(null===e)return;M=!0,D.push(e);let t=e.changes;for(let e=0;e<t.length;e++){let o=t[e];I(o.pixelIndex,o.fromColor)}L--,M=!1,z()},j=()=>{if(D.length<=0)return;let e=D.pop();if(null===e)return;E=!0,T.push(e);let t=e.changes;for(let e=0;e<t.length;e++){let o=t[e];I(o.pixelIndex,o.toColor)}L++,E=!1,z()},z=()=>{for(;P.firstChild;)P.removeChild(P.firstChild);for(let e=0;e<T.length;e++){const t=document.createElement("p");t.innerText=`${T[e].changeNumber}. ${T[e].message}`,e===T.length-1&&(t.style.border="1px solid white"),P.append(t)}P.scrollTop=P.scrollHeight;for(let e=D.length-1;e>=0;e--){const t=document.createElement("p");t.innerText=`${D[e].changeNumber}. ${D[e].message}`,t.style.fontStyle="italic",t.style.color="#aaaaaa",P.append(t)}};let B,X,J={};const A=(e,t,o)=>{X.save(),X.fillStyle=o,X.beginPath(),X.arc(e,t,5,0,2*Math.PI),X.fill(),X.restore()};let Y,G,K;const Q=(t,o,r,a)=>{if(K="Erased Pixels...",null!=o){let s=e(t.x,t.y,r,a),n=e(o.x,o.y,r,a);C(s.x,s.y,n.x,n.y,l(0,0,0,0)),v(s.x,s.y,l(0,0,0,0))}},U=(o,r,a,n)=>{if(K=`Penciled Pixels as ${t(s())}...`,null!=r){let t=e(o.x,o.y,a,n),l=e(r.x,r.y,a,n);C(t.x,t.y,l.x,l.y,s()),v(t.x,t.y,s())}},V=(a,s,c,i)=>{let h=e(a.x,a.y,c,i);var d;d=((e,t)=>{if(e<0||e>=q.width||t<0||t>=q.height)return;let o=$(e,t,q.width);return l(N[o],N[o+1],N[o+2],N[o+3])})(h.x,h.y),n(d.r,d.g,d.b,d.a),o.value=t(r)},W=()=>{G=Y.Eraser},Z=()=>{G=Y.Pencil},_=()=>{G=Y.Dropper};let ee,te,oe,re={width:64,height:64},ae={width:600,height:600},se={x:-1,y:-1},ne=!1,le=.1;const ce=e=>{var t,r,s;re=e,ee=document.querySelector("#rawimage"),t=re.width,r=re.height,s=ee,q.width=t,q.height=r,b=s,b.width=t,b.height=r,x=b.getContext("2d"),(()=>{k=x.createImageData(q.width,q.height),N=k.data;for(let e=0;e<N.length;e+=4)N[e]=0,N[e+1]=0,N[e+2]=0,N[e+3]=0;x.putImageData(k,0,0)})(),te=document.querySelector("#display"),((e,t,o)=>{window.devicePixelRatio,J.width=e,J.height=t,B=o,B.width=e,B.height=t,X=B.getContext("2d"),X.imageSmoothingEnabled=!1,X.mozImageSmoothingEnabled=!1,X.webkitImageSmoothingEnabled=!1,X.msImageSmoothingEnabled=!1})(ae.width,ae.height,te),o=document.querySelector("#colorPicker"),o.onchange=a,(()=>{const e=document.querySelector("#historyHolder");P=e.querySelector("#changes");const t=e.querySelector("#undo"),o=e.querySelector("#redo");t.onclick=O,o.onclick=j})(),document.querySelector("#eraser").onclick=W,document.querySelector("#pencil").onclick=Z,document.querySelector("#dropper").onclick=_,Y={Eraser:Q,Pencil:U,Dropper:V},G=Y.Pencil,te.onmousedown=he,document.onmouseup=de,document.onmousemove=me,te.touchstart=he,document.touchend=de,document.touchmove=me,ie()},ie=()=>{var e,t;requestAnimationFrame(ie),e=b,X.clearRect(0,0,J.width,J.height),X.save(),X.fillStyle="white",X.fillRect(0,0,J.width,J.height),X.restore(),X.drawImage(e,0,0,e.width,e.height,0,0,J.width,J.height),ne&&((e,t,o,r)=>{G(e,t,o,r)})(se,oe,ae,re),!ne&&R&&(t=K,R=!1,T.push({time:Date.now(),changes:H,changeNumber:L+=1,message:t}),H=[],T.length>1e3&&T.shift(),z()),le-=1/60,le<=0&&(le=.1,(e=>{u("/updatePlayer",y,"application/x-www-form-urlencoded",`roomId=${c}&playerId=${h}&mousePosX=${e.x}&mousePosY=${e.y}&color=${i}`)})(se),m(`/getPlayers?roomId=${c}`,w)),A(se.x,se.y,i),((e,t)=>{for(let o=0;o<e.length;o++)if(e[o].id!=t){let t=e[o].position,r=e[o].color;A(t.mousePosX,t.mousePosY,r)}})(d,h),oe=se},he=e=>{ne=!0},de=e=>{ne=!1},me=e=>{const t=te.getBoundingClientRect();se={x:e.clientX-t.x,y:e.clientY-t.y}};let ue,ge,pe,fe;const ye=()=>{ue.className="left",ge.className="right",pe.className="center",fe.className="right"},we=()=>{p();let e=ue.querySelector("#roomList");for(;e.firstChild;)e.removeChild(e.firstChild)},Se=()=>{ue.className="center",pe.className="right",pe.className="right",fe.className="right"},be=()=>{var e,t;ue.className="left",ge.className="center",pe.className="left",fe.className="right",e=pe.querySelector("#roomName").value,t=pe.querySelector("#canvasSize").value,u("/createRoom",f,"application/x-www-form-urlencoded",`roomName=${e}&canvasSize=${t}`)},xe=e=>{ue.className="left",ge.className="right",pe.className="center",fe.className="right",pe.querySelector("#message").innerText=e},ke=e=>{ue.className="left",ge.className="left",pe.className="left",fe.className="center",ce({width:parseInt(e.canvasSize),height:parseInt(e.canvasSize)})},Ne=e=>{var t;t=e.target.name,ue.className="left",ge.className="center",pe.className="right",pe.style.visibility="hidden",fe.className="right",(e=>{m("/joinRoom?id="+e,S)})(t)},qe=e=>{let t=ue.querySelector("#roomList");for(;t.firstChild;)t.removeChild(t.firstChild);let o=Object.keys(e);if(void 0!==o)if(o.length<=0)console.dir("empty");else for(let r=0;r<o.length;r++)Ie(e[o[r]].id,e[o[r]].name,t);else console.dir("null")},ve=e=>{let t=ue.querySelector("#roomList");for(;t.firstChild;)t.removeChild(t.firstChild);t.innerText=e},Ie=(e,t,o)=>{const r=document.createElement("input");r.type="button",r.id=e,r.name=e,r.value=t,r.onclick=Ne,o.append(r)};window.onload=()=>{ue=document.querySelector("#menu"),ge=document.querySelector("#loadingRoom"),pe=document.querySelector("#createRoom"),fe=document.querySelector("#paint"),ue.querySelector("#createNewRoomButton").onclick=ye,ue.querySelector("#refreshRoomListButton").onclick=we,pe.querySelector("#returnToMenuButton").onclick=Se,pe.querySelector("#createRoomButton").onclick=be,p()}})();